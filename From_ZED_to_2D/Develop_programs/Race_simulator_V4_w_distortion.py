import numpy as np
import matplotlib.pyplot as plt
import matplotlib.animation as animation
from matplotlib.patches import Rectangle
import DelanayTriangles_copy_2 as DT

import random
import keyboard



#Points from racetrack 1:
yellow_points=[[3.0, 0.0], [6.0, 0.0], [9.0, 0.0], [12.0, 0.0], [14.968847511054276, -0.37305093947226275], [17.753106463250436, -1.4690092573155287], [20.17966512028001, -3.2197335735141515], [22.097651817694757, -5.516372329582325], [23.387815432267033, -8.216131651256777], [23.969939839248653, -11.151153579987566], [24.0, -15.0], [24.734504628657763, -18.87655323162522], [26.758186164791162, -21.04882590884738], [29.575576789993782, -21.984969919624326], [32.49688101928285, -21.45578456095409], [34.806861693281604, -19.59083286462374], [36.664216154692454, -15.233042997596288], [37.69027658466946, -12.413965135238563], [38.71633701464647, -9.594887272880838], [39.74239744462348, -6.775809410523113], [41.41644517267064, -4.3239489438339325], [44.06104479140185, -2.974820187747273], [47.02870608051554, -3.0587369142634477], [49.59284205563091, -4.555153382033144], [51.905182657112405, -7.269337941714823], [53.83354548617202, -9.567471271071756], [55.761908315231636, -11.86560460042869], [57.69027114429125, -14.163737929785622], [59.20363258912161, -16.737977979647624], [59.79141630610384, -19.66568783533057], [59.500156210803205, -23.72181219596864], [59.238688982560234, -26.710396290243875], [58.97722175431726, -29.69898038451911], [58.71575452607429, -32.68756447879435], [57.91105956262807, -37.60499049322057], [56.57660754008259, -40.28313543830076], [54.621056736391054, -42.54787462891757], [52.165993828970606, -44.25839755128446], [49.3640627385007, -45.30835217487179], [46.389473969254055, -45.632457406557485], [43.42717304371586, -45.21056195281351], [40.66134148576471, -44.06889722953622], [37.24673329439849, -41.74318018442071], [34.789277161531516, -40.02245087536757], [30.373344065372752, -37.82704581920054], [27.433186417268292, -38.23878426553027], [25.050353262478897, -40.00970541011282], [22.78615577396048, -42.56671592971564], [20.291413949764475, -44.21883147589923], [17.465487680068122, -45.20237774607383], [14.484079373169688, -45.45620259688893], [11.532558557375648, -44.964524428501534], [8.794436501553319, -43.75791340801747], [5.6244042885658665, -41.574929636495376], [3.1669481556988903, -39.854200327442236], [0.7094920228319141, -38.133471018389095], [-1.747964110035062, -36.412741709335954], [-3.6830040228380994, -34.16114758966155], [-4.30168958333295, -31.25748030136416], [-3.4525449888972184, -28.412658865555976], [-1.5006884486096055, -25.598914692628764], [0.22004086044353066, -23.141458559761787], [2.415445916610563, -18.72552546360303], [2.0037074702808337, -15.78536781549857], [0.23278632569828117, -13.402534660709176], [-2.4637342579091657, -12.160426659738839], [-5.826374857763842, -11.102109914278875], [-7.814005914255694, -8.896803058722885], [-8.50103584189221, -6.00854312886461], [-7.719255753381579, -3.1444768871199336], [-5.660072679924978, -1.0058276372701584], [-2.8276464544249413, -0.11621130367865895], [0.49815038038356185, -0.1073594759765825]]
blue_points=[[3.0, -3.0], [6.0, -3.0], [9.0, -3.0], [12.0, -3.0], [14.94475227116537, -3.4953874831673613], [17.56532822762763, -4.927014653007467], [19.57323886327107, -7.1372792471867434], [20.747441112269815, -9.882861840273096], [21.0, -15.0], [21.495387483167363, -18.94475227116537], [22.92701465300747, -21.56532822762763], [25.137279247186743, -23.57323886327107], [27.882861840273097, -24.747441112269815], [30.861511932129382, -24.958671619765884], [33.74532152892428, -24.183676841431136], [36.216823257748885, -22.507772935644923], [38.00393911391737, -20.115453639722308], [39.48329401705018, -16.259103427573294], [40.509354447027185, -13.440025565215569], [41.53541487700419, -10.620947702857844], [42.5614753069812, -7.801869840500119], [44.72079898037038, -5.901375229112199], [47.48669761248492, -6.6915418262551345], [49.60704932775547, -9.197700770774441], [51.535412156815084, -11.495834100131376], [53.4637749858747, -13.793967429488308], [55.392137814934316, -16.09210075884524], [56.678487401598346, -18.767798851826303], [56.511572116527965, -23.460344967725664], [56.250104888284994, -26.4489290620009], [55.98863766004202, -29.437513156276136], [55.72717043179905, -32.42609725055138], [54.80270449067011, -37.308857382420086], [53.14812685051918, -39.79468672686936], [50.771272037597456, -41.60231940396483], [47.933798746044396, -42.532760168729304], [44.94807336529489, -42.483580419231004], [42.14278278019303, -41.46019416265365], [38.96746260345162, -39.28572405155373], [36.51000647058465, -37.56499474250059], [32.17535995194885, -35.13459902571854], [29.207562189737978, -34.80421873025788], [26.295022398478814, -35.46307126409569], [23.758370746352824, -37.03862611645056], [20.242307873062916, -40.75607959688174], [17.566486931933873, -42.08158213857216], [14.604253944288615, -42.45861055118685], [11.681709608861572, -41.84565924441297], [7.345133597619003, -39.117473503628396], [4.887677464752026, -37.396744194575255], [2.4302213318850505, -35.676014885522115], [-0.027234800981925877, -33.955285576468974], [-1.3040975376308697, -31.377654872483088], [0.9567676842573716, -27.3196440016819], [2.6774969933105077, -24.862187868814924], [5.107892710092555, -20.527541350179128], [5.438273005553224, -17.559743587968256], [4.779420471715415, -14.647203796709091], [3.2038656193605433, -12.110552144583105], [0.8850551491330942, -10.229038737727857], [-1.9217421205695824, -9.209792063069495], [-5.157927766936066, -7.502081267349734], [-5.110552686499008, -4.625918181548259], [-2.664748037020689, -3.111785389827621], [0.4981503803835628, -3.1073594759765824]]

#Points from racetrack 3:
#yellow_points=[[-3.0, 1.8369701987210297e-16], [-6.9301802326883815, 0.5559390247014857], [-9.453110080186674, 2.1464890490094337], [-11.218140752792761, 4.550587865610671], [-11.979959892832436, 7.4341023866583775], [-11.632686252877551, 10.396268049516594], [-10.224585575103369, 13.025388981781912], [-7.951362388880712, 14.956057451727876], [-5.128960064478937, 15.919939972803565], [-1.0, 16.0], [2.0, 16.0], [5.0, 16.0], [8.823212366975177, 16.87332192545161], [10.660195429836133, 19.188211227616634], [10.869238154390976, 22.136010473465436], [9.377315902755754, 24.686968577706228], [6.705600040299336, 25.949962483002228], [3.0, 26.0], [0.0, 26.0], [-3.0, 26.0], [-6.0, 26.0], [-9.0, 26.0], [-12.0, 26.0], [-15.0, 26.0], [-18.0, 26.0], [-21.909002984951364, 25.366922461719167], [-24.291827556027126, 23.582200466726874], [-25.717470080766795, 20.968653274196082], [-26.0, 16.0], [-26.0, 13.0], [-26.0, 10.0], [-26.0, 7.0], [-26.0, 4.0], [-26.0, 1.0], [-26.44663510874394, -3.9552020666133956], [-27.746643850903215, -6.646424733950352], [-29.783900317293355, -8.833269096274833], [-32.37642245523327, -10.320390859672266], [-35.29262798332297, -10.974949866040545], [-38.27202094693087, -10.738476308781951], [-41.04846104599858, -9.632093666488736], [-43.373937155412456, -7.754631805511507], [-45.04072142017061, -5.273798802338299], [-45.899924966004455, -2.4112000805986744], [-46.0, 2.0000000000000013], [-46.0, 5.000000000000002], [-46.0, 8.000000000000002], [-46.0, 11.000000000000002], [-46.0, 14.000000000000002], [-46.0, 17.0], [-46.0, 20.0], [-46.0, 23.0], [-46.0, 26.0], [-45.55336489125606, 28.955202066613396], [-44.25335614909678, 31.646424733950354], [-42.21609968270664, 33.83326909627483], [-39.62357754476673, 35.320390859672266], [-36.70737201667703, 35.97494986604055], [-33.0, 36.0], [-30.0, 36.0], [-27.0, 36.0], [-24.0, 36.0], [-21.0, 36.0], [-18.0, 36.0], [-15.0, 36.0], [-12.0, 36.0], [-9.0, 36.0], [-6.0, 36.0], [-3.0, 36.0], [0.0, 36.0], [3.0, 36.0], [6.0, 36.0], [9.0, 36.0], [11.98003996192592, 35.70099866761862], [14.84127513462976, 34.815914910043276], [17.46963710092553, 33.380034223645175], [19.76034136349284, 31.450600640207483], [21.62206477211845, 29.104534588022098], [22.980586289508395, 26.435366317150105], [23.781745949826906, 23.549507143503615], [24.0, 18.0], [24.0, 15.0], [24.0, 12.0], [23.62694906052774, 9.031152488945724], [22.530990742684473, 6.246893536749563], [20.780266426485852, 3.8203348797199883], [18.483627670417675, 1.902348182305241], [15.783868348743225, 0.6121845677329638], [12.848846420012435, 0.03006016075134532], [9.000000000000002, -2.3274478990165594e-15], [6.000000000000002, -2.8785389586328684e-15], [3.0000000000000018, -3.4296300182491773e-15]]
#blue_points=[[-3.0, 3.0], [-6.823212366975177, 3.8733219254516094], [-8.660195429836133, 6.188211227616632], [-8.869238154390976, 9.136010473465435], [-7.377315902755754, 11.686968577706228], [-4.705600040299336, 12.949962483002228], [-0.9999999999999997, 13.0], [2.0000000000000004, 13.0], [5.0, 13.0], [8.930180232688382, 13.555939024701486], [11.453110080186674, 15.146489049009434], [13.218140752792761, 17.550587865610673], [13.979959892832436, 20.434102386658378], [13.632686252877551, 23.396268049516593], [12.224585575103369, 26.025388981781912], [9.951362388880712, 27.956057451727876], [7.128960064478937, 28.919939972803565], [3.0, 29.0], [0.0, 29.0], [-3.0, 29.0], [-6.0, 29.0], [-9.0, 29.0], [-12.0, 29.0], [-15.0, 29.0], [-18.0, 29.0], [-21.955202066613396, 28.55336489125606], [-24.646424733950354, 27.25335614909678], [-26.833269096274833, 25.216099682706645], [-28.320390859672262, 22.623577544766736], [-28.974949866040546, 19.70737201667703], [-29.0, 16.0], [-29.0, 13.0], [-29.0, 10.0], [-29.0, 7.0], [-29.0, 4.0], [-29.0, 1.0000000000000002], [-29.633077538280833, -3.909002984951366], [-31.41779953327313, -6.291827556027127], [-34.031346725803914, -7.717470080766794], [-37.0009825379223, -7.928061342018748], [-39.789561332620686, -6.885509740566751], [-41.8926869388563, -4.778391276804507], [-42.92994747620312, -1.987840056419072], [-43.0, 2.0000000000000013], [-43.0, 5.000000000000002], [-43.0, 8.000000000000002], [-43.0, 11.000000000000002], [-43.0, 14.000000000000002], [-43.0, 17.0], [-43.0, 20.0], [-43.0, 23.0], [-43.0, 26.0], [-42.36692246171917, 28.909002984951364], [-40.582200466726874, 31.291827556027126], [-37.968653274196086, 32.717470080766795], [-33.0, 33.0], [-30.0, 33.0], [-27.0, 33.0], [-24.0, 33.0], [-21.0, 33.0], [-18.0, 33.0], [-15.0, 33.0], [-12.0, 33.0], [-9.0, 33.0], [-6.0, 33.0], [-2.9999999999999996, 33.0], [3.6739403974420594e-16, 33.0], [3.0000000000000004, 33.0], [6.0, 33.0], [9.0, 33.0], [11.968847511054276, 32.626949060527735], [14.753106463250438, 31.530990742684473], [17.179665120280013, 29.780266426485852], [19.09765181769476, 27.483627670417675], [20.387815432267036, 24.783868348743223], [20.969939839248653, 21.848846420012435], [21.0, 18.0], [21.0, 15.0], [21.0, 12.0], [20.504612516832637, 9.05524772883463], [19.07298534699253, 6.434671772372367], [16.86272075281326, 4.4267611367289295], [14.117138159726908, 3.252558887730183], [9.000000000000002, 2.999999999999998], [6.000000000000001, 2.9999999999999973], [3.000000000000001, 2.9999999999999964]]

#Points from racetrack 4:
#yellow_points=[[-3.0, 1.8369701987210297e-16], [-6.0, 3.6739403974420594e-16], [-9.0, 5.51091059616309e-16], [-12.0, 7.347880794884119e-16], [-15.0, 9.184850993605148e-16], [-18.0, 1.1021821192326177e-15], [-21.0, 1.2858791391047206e-15], [-24.0, 1.4695761589768236e-15], [-27.0, 1.6532731788489265e-15], [-30.0, 1.8369701987210296e-15], [-33.0, 2.0206672185931327e-15], [-35.96884751105428, 0.37305093947226453], [-38.75310646325044, 1.4690092573155304], [-41.179665120280006, 3.2197335735141532], [-43.09765181769476, 5.516372329582326], [-44.38781543226703, 8.216131651256779], [-44.96993983924865, 11.151153579987568], [-45.0, 15.000000000000002], [-45.0, 18.0], [-45.0, 21.0], [-45.0, 24.0], [-45.0, 27.0], [-45.0, 30.0], [-45.0, 33.0], [-45.0, 36.0], [-45.0, 39.0], [-45.0, 42.0], [-44.626949060527735, 44.96884751105428], [-43.53099074268447, 47.75310646325044], [-41.78026642648585, 50.179665120280006], [-39.483627670417675, 52.097651817694754], [-36.783868348743226, 53.38781543226703], [-33.848846420012435, 53.96993983924865], [-30.0, 54.0], [-27.0, 54.0], [-24.0, 54.0], [-21.0, 54.0], [-18.0, 54.0], [-15.06981976731162, 53.44406097529851], [-12.546889919813328, 51.85351095099057], [-10.781859247207239, 49.44941213438933], [-10.020040107167564, 46.565897613341626], [-10.367313747122449, 43.60373195048341], [-11.775414424896631, 40.974611018218084], [-14.048637611119286, 39.04394254827213], [-16.87103993552106, 38.08006002719644], [-21.0, 38.0], [-24.0, 38.0], [-27.0, 38.0], [-30.823212366975177, 37.126678074548394], [-32.660195429836136, 34.811788772383366], [-32.86923815439098, 31.863989526534564], [-31.377315902755754, 29.313031422293772], [-28.705600040299334, 28.050037516997772], [-25.0, 28.0], [-22.0, 28.0], [-19.0, 28.0], [-16.0, 28.0], [-13.0, 28.0], [-10.0, 28.0], [-7.0, 28.0], [-4.0, 28.0], [-1.0, 28.0], [2.0, 28.0], [4.944752271165372, 28.495387483167363], [7.565328227627633, 29.92701465300747], [9.573238863271069, 32.13727924718674], [10.747441112269815, 34.882861840273094], [11.0, 40.0], [11.0, 43.0], [11.0, 46.0], [11.555939024701486, 49.93018023268838], [13.146489049009434, 52.453110080186676], [15.550587865610671, 54.21814075279276], [18.434102386658378, 54.97995989283243], [21.396268049516593, 54.63268625287755], [24.025388981781912, 53.22458557510337], [25.956057451727876, 50.95136238888071], [26.91993997280356, 48.12896006447894], [27.0, 44.0], [27.0, 41.0], [27.0, 38.0], [27.0, 35.0], [27.0, 32.0], [27.0, 29.0], [27.0, 26.0], [27.0, 23.0], [27.0, 20.0], [27.0, 17.0], [27.0, 14.0], [27.0, 11.0], [27.0, 8.0], [27.0, 5.0], [27.0, 2.0], [27.0, -1.0], [27.0, -4.0], [27.0, -7.0], [27.0, -10.0], [27.0, -13.0], [27.0, -16.0], [26.44406097529852, -20.93018023268838], [24.853510950990575, -23.453110080186672], [22.449412134389338, -25.218140752792763], [19.56589761334163, -25.979959892832436], [16.603731950483414, -25.63268625287755], [13.974611018218095, -24.22458557510337], [12.043942548272131, -21.951362388880714], [11.080060027196444, -19.12896006447894], [11.000000000000007, -15.0], [11.000000000000007, -12.0], [11.000000000000007, -9.0], [10.504612516832644, -6.055247728834631], [9.072985346992533, -3.434671772372365], [6.86272075281326, -1.4267611367289321], [4.11713815972691, -0.25255888773018675]]
#blue_points=[[-3.0, 3.0], [-6.0, 3.0000000000000004], [-9.0, 3.0000000000000004], [-12.0, 3.000000000000001], [-15.0, 3.000000000000001], [-18.0, 3.000000000000001], [-21.0, 3.0000000000000013], [-24.0, 3.0000000000000013], [-27.0, 3.0000000000000018], [-30.0, 3.0000000000000018], [-33.0, 3.000000000000002], [-35.94475227116537, 3.495387483167363], [-38.56532822762763, 4.927014653007469], [-40.57323886327107, 7.137279247186745], [-41.74744111226981, 9.882861840273097], [-42.0, 15.000000000000002], [-42.0, 18.0], [-42.0, 21.0], [-42.0, 24.0], [-42.0, 27.0], [-42.0, 30.0], [-42.0, 33.0], [-42.0, 36.0], [-42.0, 39.0], [-42.0, 42.0], [-41.50461251683264, 44.94475227116537], [-40.07298534699253, 47.56532822762763], [-37.86272075281326, 49.57323886327107], [-35.117138159726906, 50.74744111226981], [-30.0, 51.0], [-27.0, 51.0], [-24.0, 51.0], [-21.0, 51.0], [-18.0, 51.0], [-15.176787633024823, 50.126678074548394], [-13.339804570163869, 47.811788772383366], [-13.130761845609022, 44.86398952653457], [-14.622684097244246, 42.313031422293776], [-17.294399959700662, 41.050037516997776], [-21.0, 41.0], [-24.0, 41.0], [-27.0, 41.0], [-30.930180232688382, 40.44406097529851], [-33.453110080186676, 38.85351095099057], [-35.21814075279276, 36.44941213438933], [-35.97995989283243, 33.56589761334162], [-35.63268625287755, 30.603731950483404], [-34.22458557510337, 27.974611018218084], [-31.95136238888071, 26.043942548272124], [-29.128960064478935, 25.080060027196435], [-25.0, 25.0], [-22.0, 25.0], [-19.0, 25.0], [-16.0, 25.0], [-13.0, 25.0], [-10.0, 25.0], [-7.0, 25.0], [-3.9999999999999996, 25.0], [-0.9999999999999997, 25.0], [2.0000000000000004, 25.0], [4.9688475110542765, 25.373050939472265], [7.753106463250438, 26.469009257315527], [10.17966512028001, 28.21973357351415], [12.097651817694759, 30.516372329582325], [13.387815432267034, 33.216131651256774], [13.969939839248653, 36.151153579987565], [14.0, 40.0], [14.0, 43.0], [14.0, 46.0], [14.87332192545161, 49.82321236697518], [17.188211227616634, 51.66019542983613], [20.136010473465433, 51.86923815439098], [22.686968577706228, 50.377315902755754], [23.949962483002228, 47.70560004029934], [24.0, 44.0], [24.0, 41.0], [24.0, 38.0], [24.0, 35.0], [24.0, 32.0], [24.0, 29.0], [24.0, 26.0], [24.0, 23.0], [24.0, 20.0], [24.0, 17.0], [24.0, 14.0], [24.0, 11.0], [24.0, 7.999999999999999], [24.0, 4.999999999999999], [24.0, 1.9999999999999996], [24.0, -1.0000000000000004], [24.0, -4.000000000000001], [24.0, -7.000000000000001], [24.0, -10.0], [24.0, -13.0], [24.0, -16.0], [23.126678074548398, -20.823212366975177], [20.811788772383373, -22.660195429836133], [17.863989526534574, -22.869238154390978], [15.31303142229378, -21.377315902755754], [14.05003751699778, -18.705600040299338], [14.000000000000007, -14.999999999999998], [14.000000000000007, -11.999999999999998], [14.000000000000007, -8.999999999999998], [13.626949060527743, -6.0311524889457235], [12.530990742684475, -3.246893536749562], [10.780266426485854, -0.8203348797199901], [8.483627670417679, 1.0976518176947572], [5.783868348743226, 2.3878154322670344], [2.8488464200124364, 2.969939839248651]]

#Points from racetrack 5: #IKKE God!!
#yellow_points=[[-3.0, 1.8369701987210297e-16], [-6.0, 3.6739403974420594e-16], [-9.0, 5.51091059616309e-16], [-12.0, 7.347880794884119e-16], [-15.0, 9.184850993605148e-16], [-18.0, 1.1021821192326177e-15], [-21.0, 1.2858791391047206e-15], [-24.0, 1.4695761589768236e-15], [-27.0, 1.6532731788489265e-15], [-30.0, 1.8369701987210296e-15], [-33.0, 2.0206672185931327e-15], [-35.94475227116537, -0.4953874831673595], [-38.56532822762763, -1.9270146530074657], [-40.57323886327107, -4.13727924718674], [-41.74744111226981, -6.882861840273094], [-42.0, -11.999999999999998], [-42.0, -14.999999999999998], [-42.0, -18.0], [-42.0, -21.0], [-42.0, -24.0], [-40.62090691760442, -26.52441295442369], [-36.0, -27.0], [-33.0, -27.0], [-30.0, -27.0], [-27.0, -27.0], [-24.0, -27.0], [-21.47558704557631, -25.620906917604422], [-21.272107719522957, -22.751559490358577], [-23.5766399758204, -21.030022510198666], [-28.93018023268838, -20.444060975298516], [-31.453110080186672, -18.853510950990568], [-33.218140752792756, -16.44941213438933], [-33.97995989283243, -13.565897613341624], [-33.63268625287755, -10.603731950483407], [-32.22458557510336, -7.974611018218089], [-29.951362388880707, -6.043942548272127], [-27.12896006447893, -5.080060027196439], [-22.999999999999993, -5.000000000000004], [-19.999999999999993, -5.000000000000005], [-16.999999999999993, -5.000000000000006], [-13.999999999999993, -5.000000000000007], [-10.999999999999993, -5.000000000000008], [-7.999999999999993, -5.000000000000009], [-3.0447979333865973, -5.446635108743948], [-0.3535752660496412, -6.746643850903224], [1.8332690962748437, -8.783900317293368], [3.3203908596722718, -11.376422455233275], [3.974949866040551, -14.29262798332298], [4.000000000000006, -18.000000000000007], [4.000000000000006, -21.000000000000007], [4.000000000000006, -24.000000000000007], [4.000000000000006, -27.000000000000007], [4.000000000000006, -30.000000000000007], [4.873321925451612, -32.823212366975184], [7.188211227616637, -34.660195429836136], [10.136010473465438, -34.869238154390985], [14.512071377789635, -31.901859386535275], [16.810204707146568, -29.973496557475656], [18.411550339664792, -27.48976722042404], [18.33077884584551, -24.5356691820539], [16.596106032290265, -22.143153877102144], [11.675381134707234, -20.16292205744966], [9.466976373794173, -18.15843389155785], [8.146227861541373, -15.484364378137194], [7.896699507893277, -12.512368416506451], [8.753071950240502, -9.655508140747061], [10.596322473488113, -7.310843579712547], [15.471789959824305, -4.036982919125727], [16.406250617593905, -1.233413313498482], [15.59447980272657, 1.6081087079973395], [13.32005241564844, 3.4949577521513913], [10.377491378352705, 3.7680031628528132], [6.878252526164215, 2.5476331914472894], [4.059174663806489, 1.5215727614702852]]
#blue_points=[[-3.0, 3.0], [-6.0, 3.0000000000000004], [-9.0, 3.0000000000000004], [-12.0, 3.000000000000001], [-15.0, 3.000000000000001], [-18.0, 3.000000000000001], [-21.0, 3.0000000000000013], [-24.0, 3.0000000000000013], [-27.0, 3.0000000000000018], [-30.0, 3.0000000000000018], [-33.0, 3.000000000000002], [-35.96884751105428, 2.626949060527739], [-38.75310646325043, 1.5309907426844749], [-41.179665120280006, -0.2197335735141479], [-43.097651817694754, -2.516372329582321], [-44.38781543226703, -5.216131651256774], [-44.96993983924865, -8.151153579987563], [-45.0, -11.999999999999998], [-45.0, -14.999999999999998], [-45.0, -18.0], [-45.0, -21.0], [-45.0, -24.0], [-44.26549537134224, -26.876553231625216], [-42.24181383520884, -29.048825908847377], [-39.42442321000622, -29.984969919624326], [-36.0, -30.0], [-33.0, -30.0], [-30.0, -30.0], [-27.0, -30.0], [-24.0, -30.0], [-21.123446768374784, -29.26549537134224], [-18.951174091152623, -27.24181383520884], [-18.015030080375674, -24.42442321000622], [-18.54421543904591, -21.50311898071715], [-20.40916713537626, -19.193138306718403], [-23.153279951640798, -18.060045020397332], [-28.823212366975174, -17.126678074548394], [-30.66019542983613, -14.811788772383373], [-30.86923815439097, -11.863989526534567], [-29.377315902755747, -9.313031422293774], [-26.70560004029933, -8.050037516997776], [-22.999999999999993, -8.000000000000004], [-19.999999999999993, -8.000000000000005], [-16.999999999999993, -8.000000000000007], [-13.999999999999993, -8.000000000000007], [-10.999999999999993, -8.000000000000007], [-7.999999999999993, -8.000000000000009], [-3.0909970150486266, -8.63307753828084], [-0.7081724439728676, -10.417799533273133], [0.7174700807668009, -13.031346725803925], [1.0000000000000062, -18.000000000000007], [1.0000000000000062, -21.000000000000007], [1.0000000000000062, -24.000000000000007], [1.0000000000000062, -27.000000000000007], [1.0000000000000062, -30.000000000000007], [1.5559390247014893, -32.930180232688386], [3.1464890490094364, -35.45311008018668], [5.550587865610673, -37.21814075279277], [8.43410238665838, -37.97995989283244], [11.396268049516596, -37.632686252877555], [14.025388981781916, -36.224585575103376], [16.440434206849254, -34.19999271589221], [18.738567536206187, -32.27162988683259], [20.62586510397486, -29.962272338526525], [21.536155645818166, -27.122132284822413], [21.342922652729264, -24.14594589858823], [20.073022565137652, -21.447357719047197], [17.902952137084338, -19.40143036635056], [15.134318077895689, -18.29251655476539], [12.35678141352346, -16.91451243203083], [10.949682559887506, -14.315802738622875], [11.255695631204697, -11.376487298813952], [13.167921457612596, -9.123353560365494], [16.7069186490769, -7.117717986519497], [18.533697062251115, -4.760197037644499], [19.37003313893682, -1.8974070764252462], [19.099688913435187, 1.0727677323969034], [17.760238112010978, 3.7375183672195726], [15.537843977709045, 5.726485110793766], [12.741385417410916, 6.763231905222902], [9.759527542274158, 6.703666750067651], [5.852192096187211, 5.366711053805015], [3.033114233829485, 4.340650623828011]]

#Points from ractrack 6: #IKKE God!!
#yellow_points=[[-2.5244129544236897, -1.3790930823955807], [-2.7278922804770454, -4.248440509641427], [-1.436724046314806, -7.257622834271341], [-0.9937223149578553, -10.216840976509092], [-1.2966147192942188, -13.193664575369064], [-2.3265688766577775, -16.00300915748494], [-4.019547226045562, -18.470203283580112], [-6.270288573500017, -20.441848772554536], [-8.48704026374224, -23.348840966163067], [-7.228584815626462, -25.93550839346817], [-4.3720328477522505, -26.274137023692276], [-1.30534432816669, -21.854228324153347], [0.6767922616854687, -19.61272055336522], [3.1518669223131672, -17.93128427100035], [5.965991499147876, -16.9144630411919], [8.944197355992902, -16.625477883115764], [11.901314077375272, -17.082296494224252], [14.653482468121515, -18.256516105843616], [17.029586027606005, -20.075129429763642], [20.47664953359846, -21.954580460318656], [22.805491175232344, -20.266073693211844], [22.642940232036704, -17.394116923822775], [17.662196175770866, -15.503501269316091], [12.903454257405159, -14.099891394612163], [10.6950494964921, -12.095403228720354], [9.374300984239301, -9.421333715299697], [9.124772630591202, -6.449337753668956], [9.981145072938428, -3.5924774779095654], [11.82439559618604, -1.2478129168750511], [14.398340475790345, 0.25878329710617276], [17.939165118476296, 2.3972204030962345], [17.641296184516804, 5.258309809695637], [15.072833192057365, 6.55351494817363], [11.073559925392347, 4.653218604603042], [8.47548371403903, 3.1532186046030444], [5.8774075026857115, 1.6532186046030466], [2.253759264629936, -0.008133560435458875]]
#blue_points=[[-2.8765532316252185, 2.2654953713422366], [-5.048825908847379, 0.2418138352088386], [-5.9849699196243265, -2.5755767899937827], [-5.45578456095409, -5.4968810192828546], [-4.1527944322637165, -8.797924016264814], [-4.082331951862139, -11.783222952027895], [-4.992521921684978, -14.627256868113705], [-6.783165070986741, -17.016937141470613], [-10.614296916363369, -20.368604917487435], [-11.483699470717895, -23.207300875559554], [-10.885728653050075, -26.115304734757622], [-8.966788574486335, -28.380635730169757], [-6.196702691633995, -29.4486618279386], [-3.253684638737912, -29.057892990617972], [-0.858287876489932, -27.30400305812362], [1.6204512241535003, -22.94477243545859], [3.8620304755938912, -20.97188187677966], [6.6257456881164165, -19.84101808255683], [9.607350212093774, -19.676673445862342], [12.478610811762948, -20.496940028017125], [14.923441584460013, -22.211517873985635], [17.911084208213747, -24.56703186333656], [20.857624165390227, -24.930291859283805], [23.61761236893188, -23.836435991171342], [25.515307448657985, -21.55327832507018], [26.08608746462191, -18.639815485549246], [25.190205562266712, -15.809364786292043], [23.047004876262584, -13.754919273895913], [18.183140708771656, -12.549078010279468], [13.584854536221386, -10.851481769193335], [12.177755682585435, -8.25277207578538], [12.483768753902623, -5.313456635976457], [14.395994580310523, -3.060322897527998], [18.918831736949734, -1.1308500452643706], [20.706694100206924, 1.239298412942747], [21.13938123211368, 4.176446245411428], [20.110956232287943, 6.961477226141552], [17.873213408262835, 8.91251863969927], [14.974030247369068, 9.551887503097538], [9.573559925392349, 7.251294815956359], [6.975483714039031, 5.751294815956362], [4.377407502685713, 4.2512948159563635], [0.713458082636456, 2.7079368255134497]]

#Points from racetrack 7: 
#yellow_points=[[2.954423259036624, 0.520944533000791], [7.8844360797722235, 0.6444032620427718], [10.375115664884973, -0.9713228125737609], [11.786272292476383, -3.583351242031986], [12.395718882136663, -6.953139822773638], [12.519177611178643, -11.883152643509236], [10.903451536562109, -14.373832228621982], [8.291423107103885, -15.784988856213397], [4.921634526362233, -16.394435445873675], [0.13802728668487024, -17.740944100944382], [-2.1941367834553476, -19.605879876503288], [-5.109109898935148, -22.377853563961033], [-8.01277718723254, -22.99653912445588], [-10.857598623040724, -22.147394530020144], [-13.67134279596794, -20.195537989732532], [-17.244686797348958, -16.796790997356027], [-17.863372357843804, -13.893123709058631], [-17.014227763408073, -11.048302273250448], [-14.905153225712683, -8.95883819403345], [-12.698832639854105, -6.378880314738853], [-13.50282592298304, -1.7913903196933214], [-12.586789691177497, 1.0326020963575198], [-10.428998183005826, 3.071717431780062], [-7.5577540152781975, 3.826709135829345], [-4.676037898395461, 3.112728908097897], [-2.4893944411336335, 1.1045840092653438]]
#blue_points=[[3.4753677920374155, -2.433478726035833], [8.170521747973797, -3.005964221156179], [9.441295623100038, -7.474084355774429], [8.868810127979692, -12.16923831171081], [4.400689993361441, -13.440012186837052], [-0.4278899432439279, -14.670226959697262], [-2.979538581067956, -16.23301670128923], [-5.065222272544497, -18.378511070063727], [-7.8926026161136145, -19.998947078753798], [-11.950613486914802, -17.738081856865556], [-14.865780312141727, -14.013298280177558], [-13.386670746076163, -11.54615552266497], [-10.839415527418215, -9.533178299065503], [-9.725912657602265, -6.781057861511069], [-10.068158779515068, -3.8320032441923573], [-10.050886114976796, -0.5702681579714121], [-7.536368277027146, 0.8267853617645003], [-5.002188489954864, -0.5342772015174997], [-2.9146879865451085, -3.201911151321779]]

#yellow_points
yellow_points_np=np.array(yellow_points).reshape(-1,2)
x_yellow=yellow_points_np[:,0]
y_yellow=yellow_points_np[:,1]

#blue_points
blue_points_np=np.array(blue_points).reshape(-1,2)
x_blue=blue_points_np[:,0]
y_blue=blue_points_np[:,1]



#plot
fig_1, ax_1 = plt.subplots()
ax_1.set_aspect('equal') # Set the aspect ratio to 1

ax_1.scatter(x_yellow, y_yellow, c='gold', marker='o') # Create a scatter plot object
ax_1.scatter(x_blue, y_blue, c='b', marker='o') # Create a scatter plot object



def transform_points(list_of_points, x_shift, y_shift, theta):
    #list_of_points: list of points to be transformed
    #x_shift: shift in x direction
    #y_shift: shift in y direction
    #theta: rotation angle in degrees
    #returns: list of transformed points
    list_of_points_np=np.array(list_of_points).reshape(-1,2)
    x=list_of_points_np[:,0]
    y=list_of_points_np[:,1]

    #shift
    x=x-x_shift
    y=y-y_shift

    #rotate
    theta=np.deg2rad(theta)
    x_rot=x*np.cos(theta)-y*np.sin(theta)
    y_rot=x*np.sin(theta)+y*np.cos(theta)

    transform_points_np=np.array([x_rot,y_rot]).T

    return transform_points_np

#oriantation=90 #degrees
#pos=[0,0] #position of the car x,y in meters


def car_view(pos,oriantation,procent_in_veiw=100,destortion=False, destortion_factor=0.5):
    global view_depth, view_width
    yellow_points_tran=transform_points(yellow_points_np, pos[0], pos[1], oriantation)
    blue_points_tran=transform_points(blue_points_np, pos[0], pos[1], oriantation)


    #only the points that are in front of the car within in 20 meters and 5 meters to the left and right
    #view_depth=20 #meters from the car
    #view_width=10 #meters from the center of the car

    yellow_points_tran=yellow_points_tran[np.logical_and(np.logical_and(np.abs(yellow_points_tran[:,0])<view_width, yellow_points_tran[:,1]<view_depth), yellow_points_tran[:,1]>0)]
    blue_points_tran=blue_points_tran[np.logical_and(np.logical_and(np.abs(blue_points_tran[:,0])<view_width, blue_points_tran[:,1]<view_depth), blue_points_tran[:,1]>0)]
    #midpoints_tran=midpoints_tran[np.logical_and(np.logical_and(np.abs(midpoints_tran[:,0])<view_width, midpoints_tran[:,1]<view_depth), midpoints_tran[:,1]>0)]


    #randomly remove points from yellow_points_tran and blue_points_tran according to procent_in_veiw
    if procent_in_veiw<100:
        n_yellow=yellow_points_tran.shape[0]
        k_yellow = int(n_yellow * (100-procent_in_veiw)/100) # the number of points to remove (x % of n)
        n_blue_points_tran=blue_points_tran.shape[0]
        k_blue = int(n_blue_points_tran * (100-procent_in_veiw)/100) # the number of points to remove (x % of n)

        # generate a set of indices to exclude
        exclude_yellow = set(random.sample(range(n_yellow), k_yellow))
        exclude_blue = set(random.sample(range(n_blue_points_tran), k_blue))

        # select all rows that are not in exclude
        yellow_points_tran=yellow_points_tran[np.array([i not in exclude_yellow for i in range(n_yellow)])]
        blue_points_tran=blue_points_tran[np.array([i not in exclude_blue for i in range(n_blue_points_tran)])]
        print(f"number of yellow points in view: {yellow_points_tran.shape[0]}, number of blue points in view: {blue_points_tran.shape[0]}")
        print(f"number of yellow points removed: {n_yellow-yellow_points_tran.shape[0]}, number of blue points removed: {n_blue_points_tran-blue_points_tran.shape[0]}")
        print(f"procent of points in view: {100*yellow_points_tran.shape[0]/n_yellow}% yellow, {100*blue_points_tran.shape[0]/n_blue_points_tran}% blue")

    #if destortion is true, then destort the points yellow_points_tran and midpoints_tran by randomly -1*destortion_factor or 1*destortion_factor
    if destortion==True:
        x_dest_yellow=np.random.randint(2, size=yellow_points_tran.shape[0])
        x_dest_yellow[x_dest_yellow==0]=-1
        yellow_points_tran[:,0]=yellow_points_tran[:,0]+x_dest_yellow*destortion_factor
        y_dest_yellow=np.random.randint(2, size=yellow_points_tran.shape[0])
        y_dest_yellow[y_dest_yellow==0]=-1
        yellow_points_tran[:,1]=yellow_points_tran[:,1]+y_dest_yellow*destortion_factor
        x_dest_blue=np.random.randint(2, size=blue_points_tran.shape[0])
        x_dest_blue[x_dest_blue==0]=-1
        blue_points_tran[:,0]=blue_points_tran[:,0]+x_dest_blue*destortion_factor
        y_dest_blue=np.random.randint(2, size=blue_points_tran.shape[0])
        y_dest_blue[y_dest_blue==0]=-1
        #print(f"befor - blue_points_tran[:,1]={blue_points_tran[:,1]}")
        blue_points_tran[:,1]=blue_points_tran[:,1]+y_dest_blue*destortion_factor
        #print(f"after - blue_points_tran[:,1]={blue_points_tran[:,1]}")
        #print(f"destortion example: {y_dest_blue*destortion_factor}")

    
    return yellow_points_tran, blue_points_tran#, midpoints_tran

def get_middelpoint_with_DT(yel_points, blu_points):
    #generate the point array
    point_array=[]
    for i in range(yel_points.shape[0]):
        point_array.append([yel_points[i,0],yel_points[i,1],'yellow'])

    for i in range(blu_points.shape[0]):
        point_array.append([blu_points[i,0],blu_points[i,1],'blue'])
    
    # convert the point array to a NumPy array, without color information
    point_array_without_color = DT.remove_Colors(point_array)


    # Use the filter function to remove the triangles that are made by three points of the same color
    tri = DT.delaunay_triangles_filtered(point_array, point_array_without_color)

    # Find the midpoints of the triangles that are made by two points of different color
    midpoints = DT.find_midpoints(tri, point_array)

    midpoints_np=np.array(midpoints).reshape(-1,2)
    return midpoints_np



#The car's field of view
view_depth=20 #meters from the car
view_width=10 #meters from the center of the car

#plot the car
car_pos=[0.2,0] #position of the car's back right coner x,y in meters
car_width=0.7
car_length=0.4
car_theta=90
car_speed=2.5 #meters per second

def get_stering_angle(point_pos):
    global car_length
    #point_pos: position of the point the car shall be heading towards
    #returns: stering angle in degrees
    x_1=point_pos[0]
    y_1=point_pos[1]
    radius=(x_1**2+y_1**2)/(2*x_1)
    stering_angle=np.arctan(car_length/radius)
    #print(f"stering_angle={np.rad2deg(stering_angle)}, radius={radius}, x_1={x_1}, y_1={y_1}")
    return stering_angle

def update_pos_and_oriantation(pos, oriantation, stering_angle, speed, dt):
    global start_oriantation, car_length
    #pos: position of the car's back right coner x,y in meters
    #oriantation: oriantation of the car in degrees
    #stering_angle: stering angle in radians
    #speed: speed of the car in meters per second
    #dt: time step in seconds
    #returns: new position and oriantation of the car
    x=pos[0]
    y=pos[1]
    theta=np.deg2rad(oriantation)
    theta_new=theta+speed*np.tan(stering_angle)/car_length*dt
    theta=theta_new
    stering_angle=stering_angle
    x_new=x+speed*np.cos(np.deg2rad(start_oriantation)-theta)*dt
    y_new=y+speed*np.sin(np.deg2rad(start_oriantation)-theta)*dt
    theta_new=theta+speed*np.tan(stering_angle)/car_length*dt
    return [x_new, y_new], np.rad2deg(theta_new)

#plot
fig_2, ax_2 = plt.subplots()
ax_2.set_aspect('equal') # Set the aspect ratio to 1
lim_x=plt.xlim([-view_width-1, view_width+1]) # Set the x axis limits
lim_y=plt.ylim([-1, view_depth+1]) # Set the y axis limits

#rotat the rectangle 45 degrees
car=ax_2.add_patch(Rectangle(car_pos, car_width, car_length, edgecolor='red', facecolor='red', lw=4, angle=car_theta))


start_oriantation=90
oriantation_=start_oriantation
pos_=[0,(blue_points_np[1,1]-yellow_points_np[1,1])/2]
dt=0.1#dt=0.03 #time step in seconds
stering_angle=0 #degrees
diff_angle=0
num_midtpoints_too_close=0
number_of_midpoints=4
pause=True
integral_error=0
counter=0
route_taken=[]

for i in range(2000): #run1 =920 run3=1155
    #print(f"i={i}")
    #run if key 'q' is not pressed
    if keyboard.is_pressed('z'):
        print("The key 'z' was pressed and the program is now terminated!")
        #close all figures
        plt.close('all')
        break
    plt.xlim([-view_width-1, view_width+1]) # Set the x axis limits
    plt.ylim([-1, view_depth+1]) # Set the y axis limits


    pos_,oriantation_=update_pos_and_oriantation(pos_,oriantation_,stering_angle,car_speed,dt)

    #print(f"pos_={pos_}, oriantation_={oriantation_}")

    #pos_=[pos_[0]+np.cos(np.deg2rad(90-oriantation_))*1, pos_[1]+np.sin(np.deg2rad(90-oriantation_))*1]
    
    #transformed points
    yellow_points_tran, blue_points_tran=car_view(pos_,oriantation_,80,True)
    midpoints=get_middelpoint_with_DT(yellow_points_tran[0:,:], blue_points_tran[0:,:])
    midpoints=midpoints[num_midtpoints_too_close:]
    if (midpoints[0,0]**2+midpoints[0,1]**2)<(1.2**2):
        mid_points_next=midpoints[1:number_of_midpoints+1,:]
    else:
        mid_points_next=midpoints[:number_of_midpoints,:]
    #mid_points_next=midpoints[:number_of_midpoints,:]
    """
    j=0
    k=0
    for i in range(number_of_midpoints):
        j=i
        while True:
            k+=1
            if midpoints[i,0]<abs(midpoints[i,1]):
                mid_points_next[i,:]=midpoints[i,:]
                j=1
            if k>number_of_midpoints*1.5:
                break
            j+=1
    """
    angles_x=[]
    
    gain=3/5
    sum_gain=0
    for i in range(len(mid_points_next)):
        
        angles_x.append(get_stering_angle(mid_points_next[i,:])*gain)
        sum_gain+=gain
        if gain==3/5:
            gain=2/5
        if i<(len(mid_points_next)-2):
            gain=gain/2
    
        
        """
        for j in range(gain):
            angles_x.append(get_stering_angle(mid_points_next[i,:]))
        gain-=1
    #angles_x[:]=get_stering_angle(mid_points_next[:,:])
    stering_angle=np.mean(angles_x)"""
    stering_angle_new=np.sum(angles_x)
    if stering_angle_new>np.deg2rad(25):
        stering_angle_new=np.deg2rad(25)
    if stering_angle_new<np.deg2rad(-25):
        stering_angle_new=np.deg2rad(-25)

    #PID
    #kp=0.05
    #ki=0.010
    #kd=0.005
    kp=0.4
    ki=0.001
    kd=0.001
    angle_diff=stering_angle_new-stering_angle
    integral_error+=angle_diff
    stering_angle=angle_diff*kp+integral_error*ki+(diff_angle-stering_angle)*kd
    #stering_angle+=(stering_angle_new-stering_angle)
    #stering_angle=stering_angle_new*0.05
    #print(f"angles_x={angles_x}, sum={np.sum(angles_x)}, sum gain={sum_gain}")
    #print(f"stering_angle={stering_angle}")
 
    ax_2.add_patch(Rectangle(car_pos, car_width, car_length, edgecolor='red', facecolor='red', lw=4, angle=car_theta))

    if counter%int(1/dt)==0:
        ax_1.scatter(pos_[0],pos_[1],c='r', marker='.')
    counter+=1
    route_taken.append(pos_)


    ax_2.scatter(yellow_points_tran[:,0], yellow_points_tran[:,1], c='gold', marker='o') # Create a scatter plot object
    ax_2.scatter(blue_points_tran[:,0], blue_points_tran[:,1], c='b', marker='o') # Create a scatter plot object
    ax_2.scatter(midpoints[:,0], midpoints[:,1], c='r', marker='o') # Create a scatter plot object
    
    if keyboard.is_pressed('p'):
        pause=True
        plt.pause(0.1)

    #pause the program if key 'p' is pressed
    if pause==True:
        print("The program is now paused until the key 'p' is pressed!")
        while True:
            if keyboard.is_pressed('p'):
                print("The key 'p' was pressed and the program is now continuing!")
                break
            else:
                plt.pause(0.1)
        pause=False
    
    plt.pause(dt)
    #plt.pause(8)
    ax_2.clear()
    

#show route taken in the end
route_taken_np=np.array(route_taken).reshape(-1,2)
ax_1.scatter(route_taken_np[:,0], route_taken_np[:,1], c='r', marker='.')
plt.show()

#check if any of the points in the route taken is less than 0.4 meters form the yellow or blue points
min_dist_to_cones=0.3 #meters
for i in range(route_taken_np.shape[0]):
    for j in range(yellow_points_np.shape[0]):
        dist_to_yellow=np.sqrt((route_taken_np[i,0]-yellow_points_np[j,0])**2+(route_taken_np[i,1]-yellow_points_np[j,1])**2)
        if dist_to_yellow<min_dist_to_cones:
            print(f"route_taken_np[{i}]={route_taken_np[i,:]}, yellow_points_np[{j}]={yellow_points_np[j,:]}, dist_to_yellow={dist_to_yellow} meters")
    for j in range(blue_points_np.shape[0]):
        dist_to_blue=np.sqrt((route_taken_np[i,0]-blue_points_np[j,0])**2+(route_taken_np[i,1]-blue_points_np[j,1])**2)
        if dist_to_blue<min_dist_to_cones:
            print(f"route_taken_np[i]={route_taken_np[i,:]}, blue_points_np[j]={blue_points_np[j,:]}, dist_to_blue={dist_to_blue} meters")




